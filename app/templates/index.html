<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XSS Lab - Accueil</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
    <h1>Bienvenue dans le Lab XSS</h1>
</header>
<main>
    <nav>
        <ul>
            <li><a href="/scenarios">Liste des Sc√©narios</a></li>
            <li><a href="/payloads/payloads">G√©rer les Payloads</a></li>
            <li><a href="/results/scoreboard">Scoreboard JSON</a></li>
            <li><a href="/results/report_md">Rapport Markdown</a></li>
        </ul>
    </nav>

    <hr>

    {% if last_scenario %}
        <p>Dernier sc√©nario cr√©√© : ID {{ last_scenario.id }} - {{ last_scenario.name }}</p>
    {% else %}
        <p>Aucun sc√©nario cr√©√© pour l'instant.</p>
    {% endif %}

    <form action="/payloads/upload_payload" method="POST">
        <label for="payload">Ajouter un payload :</label>
        <input type="text" name="payload">
        <button type="submit">Submit</button>
    </form>

    <form action="/payloads/upload_file" method="POST" enctype="multipart/form-data">
        <label for="file">Charger un fichier de payloads :</label>
        <input type="file" name="file">
        <button type="submit">Upload</button>
    </form>

    <hr>

    <!-- Test automatique classique -->
    <form id="form-auto" data-mode="auto">
        <label for="pid-auto">Payload ID:</label>
        <input type="number" id="pid-auto" value="1" />
        <button type="submit">Lancer le test automatique</button>
    </form>

    <!-- Test headless -->
    <form id="form-headless" data-mode="headless">
        <label for="pid-headless">Payload ID:</label>
        <input type="number" id="pid-headless" value="1" />
        <button type="submit">Lancer le test headless</button>
    </form>

    <p>Notes: seuls console.log("x") et alert() sont surveill√©s pour d√©clencher notifyXSS.</p>

    <div id="progress-container" style="display:none; margin-top: 20px;">
        <h3>Progression des tests</h3>
        <div style="width: 100%; background: #ddd; border-radius: 8px;">
            <div id="progress-bar" style="width: 0%; height: 20px; background: #007BFF; border-radius: 8px;"></div>
        </div>
        <p id="progress-text">0 / 0</p>
        <ul id="results-list" style="margin-top: 10px;"></ul>
        <a id="export-report" style="display:none; margin-top: 10px;" class="button" target="_blank">üìÑ Rapport Markdown</a>
    </div>

    <script>
        let testEnCours = false;

        function uuidv4() {
            // Generate a random session ID
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function updateResultsList(payloadId, allResults, resultsList) {
            let handled = 0;
            let total = allResults.length;
            let hasPending = false;

            allResults.forEach(r => {
                const liId = `result-${r.scenario_id}`;
                let li = document.getElementById(liId);
                if (!li) {
                    li = document.createElement("li");
                    li.id = liId;
                    resultsList.appendChild(li);
                }
                const link = `/scenario/${r.scenario_id}?payload_id=${payloadId}`;
                li.innerHTML = `<a href="${link}" target="_blank"><strong>${r.scenario_name || 'Scenario ' + r.scenario_id}</strong></a>`;

                if (r.status === "pending") {
                    li.innerHTML += " ‚è≥ En attente";
                    li.style.color = "gray";
                    hasPending = true;
                } else if (r.triggered === "Yes") {
                    li.innerHTML += " ‚úÖ XSS d√©clench√©e";
                    li.style.color = "green";
                    handled++;
                } else {
                    li.innerHTML += " ‚ùå Non d√©clench√©e";
                    li.style.color = "red";
                    handled++;
                }
            });

            return { handled, total, hasPending };
        }

        function pollScoreboard(payloadId, progressBar, progressText, resultsList, exportBtn) {
            // Poll the scoreboard for all scenarios for this payload
            const interval = setInterval(() => {
                fetch(`/results/scoreboard?payload_id=${payloadId}`)
                    .then(r => r.json())
                    .then(allResults => {
                        const { handled, total, hasPending } = updateResultsList(payloadId, allResults, resultsList);

                        const percent = total === 0 ? 0 : Math.floor((handled / total) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressText.textContent = `${handled} / ${total}`;

                        if (!hasPending) {
                            clearInterval(interval);
                            exportBtn.href = `/results/report_md?payload_id=${payloadId}`;
                            exportBtn.style.display = "inline-block";
                            testEnCours = false;
                        }
                    });
            }, 2000);
        }

        function runHeadlessTestWithSSE(payloadId) {
            if (testEnCours) {
                alert("Un test est d√©j√† en cours.");
                return;
            }
            testEnCours = true;

            const sessionId = uuidv4();
            const progressContainer = document.getElementById("progress-container");
            const progressBar = document.getElementById("progress-bar");
            const progressText = document.getElementById("progress-text");
            const resultsList = document.getElementById("results-list");
            const exportBtn = document.getElementById("export-report");

            progressContainer.style.display = "block";
            progressBar.style.width = "0%";
            resultsList.innerHTML = "";
            exportBtn.style.display = "none";

            // Start the headless test
            fetch(`/auto_headless/run_all?payload_id=${payloadId}&session_id=${sessionId}`)
                .then(resp => resp.json())
                .then(data => {
                    // Listen for progress updates via SSE
                    const evtSource = new EventSource(`/progress/stream?session_id=${sessionId}`);
                    
                    evtSource.onmessage = function(event) {
                        const [done, total] = event.data.split(',').map(Number);
                        const percent = total === 0 ? 0 : Math.floor((done / total) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressText.textContent = `${done} / ${total}`;
                        
                        if (done >= total) {
                            evtSource.close();
                            // Once SSE is done, poll for final results
                            fetch(`/results/scoreboard?payload_id=${payloadId}`)
                                .then(r => r.json())
                                .then(allResults => {
                                    updateResultsList(payloadId, allResults, resultsList);
                                    exportBtn.href = `/results/report_md?payload_id=${payloadId}`;
                                    exportBtn.style.display = "inline-block";
                                    testEnCours = false;
                                });
                        }
                    };
                    
                    evtSource.onerror = function() {
                        evtSource.close();
                        // Fall back to polling if SSE fails
                        pollScoreboard(payloadId, progressBar, progressText, resultsList, exportBtn);
                    };
                })
                .catch(err => {
                    alert("Erreur : " + err);
                    testEnCours = false;
                });
        }

        function runRegularTest(payloadId) {
            if (testEnCours) {
                alert("Un test est d√©j√† en cours.");
                return;
            }
            testEnCours = true;

            const progressContainer = document.getElementById("progress-container");
            const progressBar = document.getElementById("progress-bar");
            const progressText = document.getElementById("progress-text");
            const resultsList = document.getElementById("results-list");
            const exportBtn = document.getElementById("export-report");

            progressContainer.style.display = "block";
            progressBar.style.width = "0%";
            resultsList.innerHTML = "";
            exportBtn.style.display = "none";

            fetch(`/auto/run_all?payload_id=${payloadId}`)
                .then(resp => resp.json())
                .then(data => {
                    pollScoreboard(payloadId, progressBar, progressText, resultsList, exportBtn);
                })
                .catch(err => {
                    alert("Erreur : " + err);
                    testEnCours = false;
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Regular test form
            document.getElementById("form-auto").addEventListener("submit", function(e) {
                e.preventDefault();
                const payloadId = document.getElementById("pid-auto").value;
                runRegularTest(payloadId);
            });
            
            // Headless test form with SSE
            document.getElementById("form-headless").addEventListener("submit", function(e) {
                e.preventDefault();
                const payloadId = document.getElementById("pid-headless").value;
                runHeadlessTestWithSSE(payloadId);
            });
        });
    </script>
</main>
</body>
</html>
